generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isGuest      Boolean @default(true)
  email        String? @unique
  passwordHash String?

  nickname          String?
  dailySmokingRange DailySmokingRange?
  dayStartTime      String  @default("04:00")

  currentTargetInterval Int     @default(60)
  currentMotivation     String?

  totalDelayMinutes Int @default(0)
  intervalLevel     Int @default(1)

  notifyOnTargetTime  Boolean @default(true)
  notifyMorningDelay  Boolean @default(false)
  notifyDailyReminder Boolean @default(false)

  smokingRecords SmokingRecord[]
  dailySnapshots DailySnapshot[]
  badges         UserBadge[]

  @@index([isGuest])
}

enum DailySmokingRange {
  UNDER_5
  FROM_5_10
  FROM_10_20
  OVER_20
  UNKNOWN
}

model SmokingRecord {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  smokedAt DateTime

  type RecordType

  reasonCode ReasonCode?
  reasonText String?

  coachingMode   CoachingMode @default(NONE)
  emotionNote    String?
  delayedMinutes Int          @default(0)

  intervalFromPrevious Int?
  targetIntervalAtTime Int?
  wasOnTarget          Boolean?

  @@index([userId, smokedAt])
  @@index([userId, createdAt])
}

enum RecordType {
  FIRST
  NORMAL
  EARLY
}

enum ReasonCode {
  BREAK_TIME
  STRESS
  HABIT
  BORED
  SOCIAL
  AFTER_MEAL
  OTHER
}

enum CoachingMode {
  NONE
  LIGHT
  FULL
}

model DailySnapshot {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime @db.Date

  targetInterval Int
  motivation     String?

  totalSmoked       Int    @default(0)
  averageInterval   Float?
  totalDelayMinutes Int    @default(0)

  firstSmokeTime DateTime?

  hasDelaySuccess Boolean @default(false)

  @@unique([userId, date])
  @@index([userId, date])
}

model UserBadge {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeType BadgeType
  metadata  Json?

  @@unique([userId, badgeType])
  @@index([userId])
}

enum BadgeType {
  FIRST_DELAY
  DAILY_10_MINUTES
  STREAK_3_DAYS
  STREAK_7_DAYS
  MAX_INTERVAL_90
  TOTAL_200_MINUTES
  TOTAL_500_MINUTES
  LEVEL_2
  LEVEL_3
  LEVEL_4
  LEVEL_5
}
