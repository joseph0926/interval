name: CI & Deploy

on:
  push:
    branches: [main]
    paths:
      - "apps/server/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/ci.yml"
  workflow_dispatch:

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10.24.0
  FLY_APP: interval

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm --filter @interval/server db:gen
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
      - run: pnpm typecheck

  build:
    needs: [lint, typecheck]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - name: Generate Prisma Client
        run: pnpm --filter @interval/server db:gen
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
      - run: pnpm build
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"

  security-scan:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/server/Dockerfile
          push: false
          load: true
          tags: ${{ env.FLY_APP }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.FLY_APP }}:scan
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  # deploy:
  #   needs: [security-scan]
  #   runs-on: ubuntu-latest
  #   concurrency:
  #     group: deploy-production
  #     cancel-in-progress: false

  #   steps:
  #     - uses: actions/checkout@v6

  #     - name: Setup Fly.io CLI
  #       uses: superfly/flyctl-actions/setup-flyctl@master

  #     - name: Generate deployment info
  #       id: info
  #       run: |
  #         SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
  #         echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
  #         echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S KST' -d '+9 hours')" >> $GITHUB_OUTPUT

  #     - name: Deploy to Fly.io
  #       run: |
  #         flyctl deploy \
  #           --remote-only \
  #           --config apps/server/fly.toml \
  #           --strategy immediate
  #       env:
  #         FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  #     - name: Verify deployment
  #       run: |
  #         echo "Waiting for deployment stabilization..."
  #         sleep 20

  #         for i in {1..5}; do
  #           if curl -sf https://interval.fly.dev/api/health; then
  #             echo "Health check passed!"
  #             exit 0
  #           fi
  #           echo "Attempt $i/5 failed, retrying in 10s..."
  #           sleep 10
  #         done

  #         echo "Health check failed"
  #         exit 1

  #     - name: Deployment summary
  #       if: always()
  #       run: |
  #         echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
  #         echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
  #         echo "| **App** | ${{ env.FLY_APP }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| **Commit** | \`${{ steps.info.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
  #         echo "| **Time** | ${{ steps.info.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
  #         echo "| **URL** | https://interval.fly.dev |" >> $GITHUB_STEP_SUMMARY
